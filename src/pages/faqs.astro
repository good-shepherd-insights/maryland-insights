---
import ImageMod from "@/components/ImageMod.astro";
import Base from "@/layouts/Base.astro";
import { getListPage } from "@/lib/contentParser.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import PageHeader from "@/partials/PageHeader.astro";
import Testimonial from "@/partials/Testimonial.astro";

const pageIndex = await getListPage("faqs", "-index");
if (pageIndex.data.draft) return Astro.redirect("/404");

const { title, description, section_title, faqs_list, cta } = pageIndex.data;
---

<Base {...pageIndex.data}>
  <PageHeader title={title} description={description} />

  <section class="section-sm bg-light">
    <div class="container">
      {
        section_title && (
          <h2
            data-aos="fade-up-sm"
            data-aos-delay="150"
            class="mb-12 text-center xl:w-[60%] mx-auto text-balance"
            set:html={markdownify(section_title)}
          />
        )
      }

      <div
        class="flex flex-col-reverse lg:flex-row items-start justify-center gap-6"
      >
        <!-- Left Side -->
        <div
          class="w-full lg:max-w-93.75 text-center bg-body p-6 lg:p-8 lg:sticky lg:top-30 mt-5 relative"
        >
          <svg
            class="absolute left-0 top-px -translate-y-full w-full h-5"
            style="color: var(--color-body)"
            viewBox="0 0 385 19"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="none"
            aria-hidden="true"
          >
            <path
              d="M248.975 0C259.685 0 268.428 8.41891 268.949 19H0C0.521052 8.41891 9.26425 0 19.9746 0C28.8343 0 36.3474 5.76112 38.9746 13.7412C41.6018 5.76112 49.1149 0 57.9746 0C67.4101 0 75.3183 6.5342 77.4238 15.3242C79.3357 6.56136 87.1384 0 96.4746 0C105.728 0 113.476 6.44493 115.475 15.0908C117.473 6.44493 125.221 0 134.475 0C143.728 0 151.476 6.44493 153.475 15.0908C155.473 6.44493 163.221 0 172.475 0C181.811 0 189.612 6.56146 191.524 15.3242C193.63 6.53408 201.539 0 210.975 0C219.834 0 227.347 5.76112 229.975 13.7412C232.602 5.76112 240.115 0 248.975 0ZM364.975 0C375.685 0 384.428 8.41891 384.949 19H268.981C269.247 8.46153 277.872 0 288.475 0C297.811 0 305.612 6.56146 307.524 15.3242C309.63 6.53408 317.539 0 326.975 0C335.834 0 343.347 5.76112 345.975 13.7412C348.602 5.76112 356.115 0 364.975 0Z"
              fill="currentColor"></path>
          </svg>

          <svg
            class="absolute left-0 bottom-px translate-y-full rotate-180 w-full h-5"
            style="color: var(--color-body)"
            viewBox="0 0 385 19"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="none"
            aria-hidden="true"
          >
            <path
              d="M248.975 0C259.685 0 268.428 8.41891 268.949 19H0C0.521052 8.41891 9.26425 0 19.9746 0C28.8343 0 36.3474 5.76112 38.9746 13.7412C41.6018 5.76112 49.1149 0 57.9746 0C67.4101 0 75.3183 6.5342 77.4238 15.3242C79.3357 6.56136 87.1384 0 96.4746 0C105.728 0 113.476 6.44493 115.475 15.0908C117.473 6.44493 125.221 0 134.475 0C143.728 0 151.476 6.44493 153.475 15.0908C155.473 6.44493 163.221 0 172.475 0C181.811 0 189.612 6.56146 191.524 15.3242C193.63 6.53408 201.539 0 210.975 0C219.834 0 227.347 5.76112 229.975 13.7412C232.602 5.76112 240.115 0 248.975 0ZM364.975 0C375.685 0 384.428 8.41891 384.949 19H268.981C269.247 8.46153 277.872 0 288.475 0C297.811 0 305.612 6.56146 307.524 15.3242C309.63 6.53408 317.539 0 326.975 0C335.834 0 343.347 5.76112 345.975 13.7412C348.602 5.76112 356.115 0 364.975 0Z"
              fill="currentColor"></path>
          </svg>
          <div data-aos="fade-up-sm" data-aos-delay="100">
            <ImageMod
              src={cta.image}
              alt=""
              width={182}
              height={182}
              class="mx-auto mb-6 w-45.5 h-45.5"
              aria-hidden="true"
            />
            <h4
              data-aos="fade-up-sm"
              data-aos-delay="100"
              class="h6"
              set:html={markdownify(cta.title)}
            />

            <p
              class="text-balance mt-4 mb-15"
              data-aos="fade-up-sm"
              data-aos-delay="100"
              set:html={markdownify(cta.description)}
            />

            {
              cta.button.enable && (
                <a
                  data-aos="fade-up-sm"
                  data-aos-delay="150"
                  class="btn btn-dark"
                  rel="noopener noreferrer"
                  href={cta.button.link}
                >
                  {cta.button.label}
                </a>
              )
            }
          </div>
        </div>

        <!-- Right Side: FAQ Accordion -->
        <div
          class="w-full lg:max-w-218 flex flex-col gap-4"
          data-aos="fade-left-sm"
          data-aos-delay="100"
        >
          {
            faqs_list?.map((faq, i) => (
              <div
                role="button"
                tabindex="0"
                aria-expanded="false"
                aria-controls={`faq-answer-${i}`}
                class="group p-6 rounded-2xl cursor-pointer transition-all duration-300 bg-body flex flex-col faq-item-fix"
                data-faq-id={i}
              >
                <div class="flex justify-between items-center">
                  <h6 set:html={markdownify(faq.question)} />
                  <span
                    class="toggle-icon text-text-light text-[32px] transition-all duration-300 rotate-0"
                    aria-hidden="true"
                  >
                    +
                  </span>
                </div>

                <p
                  id={`faq-answer-${i}`}
                  class="faq-answer overflow-hidden max-h-0 opacity-0 transition-[max-height,opacity] duration-[600ms,400ms] ease-in-out max-w-195"
                  set:html={markdownify(faq.answer)}
                />
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>

  <Testimonial />
  <CallToAction />
</Base>

<script>
  interface FAQElements {
    item: HTMLElement;
    answer: HTMLElement;
    icon: HTMLElement;
  }

  class FAQAccordion {
    private items: HTMLElement[];
    private activeItem: HTMLElement | null = null;

    constructor() {
      this.items = Array.from(
        document.querySelectorAll<HTMLElement>(".faq-item-fix")
      );
      this.init();
    }

    private init(): void {
      if (this.items.length === 0) return;

      // Open first item by default
      this.openItem(this.items[0]);

      // Add event listeners
      this.items.forEach((item) => {
        item.addEventListener("click", (e) => this.handleClick(e, item));
        item.addEventListener("keydown", (e) => this.handleKeydown(e, item));
      });
    }

    private getElements(item: HTMLElement): FAQElements | null {
      const answer = item.querySelector<HTMLElement>(".faq-answer");
      const icon = item.querySelector<HTMLElement>(".toggle-icon");

      if (!answer || !icon) {
        console.warn("FAQ item missing required elements");
        return null;
      }

      return { item, answer, icon };
    }

    private handleClick(e: Event, item: HTMLElement): void {
      e.preventDefault();
      this.toggleItem(item);
    }

    private handleKeydown(e: KeyboardEvent, item: HTMLElement): void {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        this.toggleItem(item);
      } else if (e.key === "ArrowDown") {
        e.preventDefault();
        this.focusNext(item);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        this.focusPrevious(item);
      }
    }

    private focusNext(currentItem: HTMLElement): void {
      const currentIndex = this.items.indexOf(currentItem);
      const nextIndex = (currentIndex + 1) % this.items.length;
      this.items[nextIndex].focus();
    }

    private focusPrevious(currentItem: HTMLElement): void {
      const currentIndex = this.items.indexOf(currentItem);
      const previousIndex =
        currentIndex === 0 ? this.items.length - 1 : currentIndex - 1;
      this.items[previousIndex].focus();
    }

    private toggleItem(item: HTMLElement): void {
      const isCurrentlyActive = this.activeItem === item;

      // Close all items
      this.items.forEach((i) => this.closeItem(i));

      // Open clicked item if it wasn't already active
      if (!isCurrentlyActive) {
        this.openItem(item);
      }
    }

    private openItem(item: HTMLElement): void {
      const elements = this.getElements(item);
      if (!elements) return;

      const { answer, icon } = elements;

      // Update ARIA attributes
      item.setAttribute("aria-expanded", "true");

      // Set max height for smooth animation
      answer.style.maxHeight = `${answer.scrollHeight}px`;

      // Update classes
      answer.classList.remove("opacity-0");
      answer.classList.add("opacity-100");

      icon.classList.remove("rotate-0");
      icon.classList.add("rotate-180");
      icon.textContent = "âˆ’";

      item.classList.remove("bg-transparent", "gap-0");
      item.classList.add("bg-body", "gap-2");

      this.activeItem = item;
    }

    private closeItem(item: HTMLElement): void {
      const elements = this.getElements(item);
      if (!elements) return;

      const { answer, icon } = elements;

      // Update ARIA attributes
      item.setAttribute("aria-expanded", "false");

      // Reset max height
      answer.style.maxHeight = "0";

      // Update classes
      answer.classList.remove("opacity-100");
      answer.classList.add("opacity-0");

      icon.classList.remove("rotate-180");
      icon.classList.add("rotate-0");
      icon.textContent = "+";

      item.classList.remove("bg-dark", "gap-2");
      item.classList.add("bg-body", "gap-2");

      if (this.activeItem === item) {
        this.activeItem = null;
      }
    }
  }

  // Initialize FAQ accordion when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    new FAQAccordion();
  });

  // Handle navigation events for Astro
  document.addEventListener("astro:page-load", () => {
    new FAQAccordion();
  });
</script>
