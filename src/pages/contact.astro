---
import ImageMod from "@/components/ImageMod.astro";
import DynamicIcon from "@/helpers/DynamicIcon";
import Base from "@/layouts/Base.astro";
import { getListPage } from "@/lib/contentParser.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import PageHeader from "@/partials/PageHeader.astro";

const pageIndex = await getListPage("contact", "-index");
const {
  title,
  description,
  section_title,
  contact_form,
  contact_info,
  gallery_section,
} = pageIndex.data;

const toContactHref = (rawValue: string) => {
  const value = (rawValue ?? "").trim();
  if (!value) return "#";
  if (
    value.startsWith("mailto:") ||
    value.startsWith("tel:") ||
    value.startsWith("http://") ||
    value.startsWith("https://")
  ) {
    return value;
  }
  if (value.includes("@")) return `mailto:${value}`;
  if (/^\+?[0-9()\-\s.]+$/.test(value))
    return `tel:${value.replace(/\s+/g, "")}`;
  if (value.startsWith("www.")) return `https://${value}`;
  return value;
};

if (pageIndex.data.draft) {
  return Astro.redirect("/404");
}
---

<Base {...pageIndex.data}>
  <PageHeader title={title} description={description} />
  <section class="section-sm bg-light">
    <div class="container lg:w-[80%] xl:w-[70%] mx-auto">
      <h2
        data-aos="fade-up-sm"
        data-aos-delay="150"
        class="mb-12 text-center xl:w-[60%] mx-auto text-balance"
        set:html={markdownify(section_title)}
      />

      <div
        class="flex flex-col gap-7.5 justify-center lg:flex-row lg:items-stretch"
      >
        {
          contact_form.enable && (
            <div
              data-aos="fade-right-sm"
              data-aos-delay="250"
              class="lg:w-[65%]"
            >
              <form
                action={contact_form.form_action}
                method="POST"
                class="bg-body p-7 rounded-3xl card-shadow w-full h-full"
              >
                {contact_form.fields?.map((field) => (
                  <div class="mb-6">
                    <label for={field.name} class="form-label">
                      {field.label}
                      {field.required && <span class="text-red-500">*</span>}
                    </label>
                    {field.type === "textarea" ? (
                      <textarea
                        id={field.name}
                        name={field.name}
                        class="form-input"
                        placeholder={field.placeholder}
                        rows={4}
                        required={field.required}
                      />
                    ) : (
                      <input
                        id={field.name}
                        name={field.name}
                        class="form-input"
                        placeholder={field.placeholder}
                        type={field.type as any}
                        required={field.required}
                      />
                    )}
                  </div>
                ))}

                <button type="submit" class="btn btn-dark w-full rounded-full">
                  {contact_form.submit_button_label}
                </button>
              </form>
            </div>
          )
        }
        <!-- Contact Information  -->
        {
          contact_info.enable && (
            <div class="lg:w-[35%]">
              <div class="flex flex-wrap justify-center lg:flex-col gap-7.5 w-full">
                {contact_info.informations?.map((info, i) => (
                  <div
                    data-aos="fade-left-sm"
                    data-aos-delay={250 + i * 100}
                    class="bg-body p-7 rounded-3xl card-shadow flex-1 min-w-62"
                  >
                    <DynamicIcon
                      icon={info.icon}
                      className="text-text-dark text-3xl"
                    />
                    <h4 class="h5 font-primary mt-5 mb-3">{info.label}</h4>
                    <a
                      class="text-text-light break-all"
                      href={toContactHref(info.value)}
                    >
                      {info.value}
                    </a>
                  </div>
                ))}
              </div>
            </div>
          )
        }
      </div>
    </div>
  </section>

  <!-- Gallery Section  -->
  {
    gallery_section.enable && (
      <section
        class="section section-divider bg-dark"
        style="--section-divider-color: var(--color-dark)"
      >
        <div class="container">
          <h2
            data-aos="fade-up-sm"
            data-aos-delay="150"
            set:html={markdownify(gallery_section.title)}
            class="mb-12 text-white xl:w-[60%] mx-auto text-balance text-center"
          />

          {gallery_section.image && (
            <div data-aos="zoom-in-sm" data-aos-delay="150">
              <ImageMod
                src={gallery_section.image}
                alt={section_title}
                width={1500}
                height={600}
                class="mx-auto rounded-3xl"
              />
            </div>
          )}

          <div class="flex flex-wrap justify-center gap-7.5 w-full mt-7.5">
            {gallery_section.locations?.map((location, i) => (
              <div
                data-aos="fade-right-sm"
                data-aos-delay={250 + i * 100}
                class="bg-body/5 p-7 rounded-2xl flex-1 min-w-62"
              >
                <DynamicIcon
                  icon={location.icon}
                  className="text-text-light text-4xl mb-6"
                />
                <h4 class="h5 font-primary mb-2 text-white">{location.name}</h4>
                <a
                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location.address)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="hover:underline"
                >
                  {location.address}
                </a>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }
  <CallToAction />
</Base>
